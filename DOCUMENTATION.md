# DOCUMENTATION

## Requirements

HyDaMaCa uses the open-source CFD software OpenFOAM in the version distributed by the [OpenFOAM Foundation](https://openfoam.org/) and thus requires a working installation of OpenFOAM to function. For the published software tool [version 10](https://openfoam.org/download/10-ubuntu/) of OpenFOAM is used on Ubuntu 22. Additionally, [Python 3.10](https://www.python.org/downloads/release/python-3100/) is used with its standard libraries as well as [numpy](https://github.com/numpy/numpy/releases/tag/v2.2.4) and [numpy-stl](https://pypi.org/project/numpy-stl/3.2.0/).

## Fluid Domains

A mesh describing the simulation domain and its discretization must be generated. In HyDaMaCa the `blockMesh` utility of OpenFOAM is used for this purpose. As a basis for the domain size, the side length of a bounding cube centred at the origin of the object to be analyzed is determined and multiplied by three. The base resolution of a cubic subdivision of this base domain is 30 cells per direction. With the required domain limits being different for fully submerged and floating bodies, two different sets of case skeletons for these two situations are used.

For fully submerged bodies two different domains are required, one for linear and one for rotational flows. Note that only linear flows parallel to the coordinate axis and rotational flows around one coordinate axis are considered. The domain for the linear flows is based on the basis cube with equal resolution of cells in all directions. The object to be analyzed is placed in the centre of this cubic domain. This base domain is extended to a square rectangular prism by doubling the length (and number of cells) of the domain in the direction of flow (Fig. 1a). This extension of the domain creates enough space for the flow to fully evolve behind the object to be analyzed. For the circular flow a cylindrical domain with the object to be analyzed in the centre is chosen (Fig. 1b). It is important to note that a cylindrical domain with a cubic cell as a base unit must be created from a central block that is a square rectangular prism (here with full height and half the diameter of the cubic base domain) and then outer blocks with increasing deformation to resemble a circular outer shape. Otherwise, a singularity is created at the centre of the domain along the cylinder‚Äôs height. This would be particularly problematic, since the object to be analyzed is placed along that line and thus the singularity would be part of the object, too.

For bodies floating at the free surface five different domain shapes are required. The domains for linear flows in ùë•- and ùë¶-direction (Fig. 1c) are equal to the lower half (i.e. half of the z-direction) of the domains for corresponding linear flows of fully submerged bodies. If the linear flow is in z-direction, the upward and downward flow direction must be treated separately. For an upward flow halving the base cube in the z-direction yields a sufficient domain (Fig. 1d) since the free surface limits the region behind the object to be analyzed. This is not the case for downward flows, such that 1.5 times the base cube in z-direction can be used as domain (Fig. 1e). Similar to the linear cases, the domains for rotational flows are the lower half of the corresponding domains for the rotational flows of fully submerged bodies. Since the division happens along the x-y-plane (i.e. the free surface) for all three rotational cases, for rotation around the x- and y-axis, this yields half cylinders as domains (Fig. 1f), while a cylinder of half the base height is obtained for rotations around the z-axis (Fig. 1g).

![Figure_1](https://github.com/user-attachments/assets/206d2177-6b4d-4cae-b669-f991d0fa7790)
Figure 1: Domain shapes and discretization for (a, b) submerged and (c-g) floating objects experiencing a (a, c-e) linear and (b, f, g) rotational flow. For floating objects, different domain shapes are required for flows in (c, f) ùë•- and ùë¶- as well as (d, e, g) ùëß-direction for both (c-e) linear and (f, g) rotational flows with the former requiring specific treatment of (d) upward and (e) downward flows. All domains contain a sphere as a sample object to visualize the location of objects to be analyzed in the domain.

## STL File Constraints

The object to be analyzed is generated from a user provided STL file. For cases of fully submerged objects, it is required that the origin of the object in STL format coincides with its centre of gravity (CG) and the object is oriented such that the bow points into the positive x-direction and the port side coincides with the positive y-direction (Fig. 2). While required to calculate correct moments acting on the object, this additionally leads to a smaller domain size and thus to more accurate results at a given resolution (in number of cells). For cases of floating objects, the same applies for the origin with respect to the x- and y-coordinates of the object and its orientation. However, in the z-direction, the x-y-plane (i.e. the plane defined by z=0) must coincide with the free surface at equilibrium. The z-component of CG with respect to the free surface (i.e. the value has negative sign if CG is below the free surface) must be provided by the user to enable correct moment calculations. While it is technically possible to position a floating object along the z-axis in a non-equilibrium state, the obtained results would only be valid for the object in a state of non-zero heave. The latter might be desired but does not represent the standard use case of the software tool and has not yet been tested.

![Figure_2](https://github.com/user-attachments/assets/c192d206-fd7e-4bec-98b7-545bc6a9bd83)

Figure 2: The used body-fixed coordinate system with the six degrees of freedom and corresponding forces, moments, velocities and angular velocities in a three-dimensional scenario.

## SnappyHexMesh

To create the body to be analyzed in the previously prepared fluid domain from a given STL file two OpenFOAM utilities are used. First, the STL file is copied to the appropriate location in the case directory and given a generic name, such that the filename can be a hardcoded parameter in the ASCII files used to configure the OpenFOAM utilities. Then, the STL file is turned into a format usable within OpenFOAM by the `surfaceFeature` utility. The converted mesh is integrated into the fluid domain by OpenFOAM‚Äôs `snappyHexMesh` utility, which executes three distinct phases. In a first so-called castellation phase, the cells of the background mesh (i.e. the domain mesh previously created with the blockMesh utility) are split at the edges and then the surfaces of the feature (i.e. the converted object from the STL file). Then all cells that are fully within the feature are removed, after which refinements of the boundary region happen to reduce the overlap between background mesh and the feature. This concludes the castellation phase. In the following snapping phase, overlaps between the background mesh and feature as well as holes in the background mesh are removed by connecting the feature surface with the cells of the locally refined background mesh. The cell boundaries of the background mesh are snapped onto the feature‚Äôs surface, hence the phase‚Äôs name. During the final boundary layer phase, the boundary between feature and background mesh that was created during snapping is pushed outwards and a new, smoother boundary layer is created at the feature surface. While the size of the new boundary layer cells depends on the cell properties obtained during the castellation phase, the thickness of the boundary layers (in number of cells) is the determining parameter for the result of the boundary layer phase. 

## Boundary and Initial Conditions

For the cases of fully submerged objects in a linear flow, the four walls (i.e. passive walls) of the domain orthogonal to the flow direction have `slip` boundary conditions for velocity. The wall from which the flow originates (i.e. the inlet) has a `fixedValue` velocity boundary condition with the flow‚Äôs velocity. The opposite wall (i.e. the outlet) gets a `zeroGradient` boundary condition for velocity. The surface of the feature has a `fixedValue` boundary condition with 0 velocity (i.e. watertight boundary condition). Finally, the initial condition of the internal velocity field is `uniform` with the inflow velocity to avoid having to wait for the velocity to propagate over the whole domain during simulation time. All walls additionally have a `zeroGradient` boundary condition for pressure, with the initial value for the internal field being 0. These boundary and initial conditions (Tab. 1) essentially create a virtual flume tank setup. Instead of being circulated in the tank, the flow in the virtual setup is constantly created at the inlet and consumed at the outlet during a simulation run. Just like in a real flume tank, the walls along the flow direction are supposed to be far enough away from the object of interest such that they do not influence the flow around it. In the simulation they are specifically setup to not influence the flow by using the `slip` boundary condition.

Table 1: Boundary and initial conditions for cases of objects in a linear flow.
| domain part | velocity (U) | pressure (p) | turbulent viscosity (nut) |
|:---:|:---:|:---:|:---:|
| inlet | `fixedValue uniform` **v** | `zeroGradient` | `calculated` |
| outlet | `zeroGradient` | `zeroGradient` | `calculated` |
| passive walls | `slip` | `zeroGradient` | `nutUSpaldingWallFunction` |
| STL surface | `fixedValue uniform (0 0 0)` | `zeroGradient` | `nutUSpaldingWallFunction` |
| internal field | `uniform` **v** | `uniform 0` | `uniform 0.0001` |
| free surface<sup>(a)</sup> | `symmetry` | `symmetry` | `symmetry` |
| free surface = outlet <sup>(b)</sup> | `inletOutlet	uniform (0 0 0)` | `fixedValue uniform 0` | `inletOutlet uniform 0` |

<sup>(a)</sup>only present for cases of floating object with linear flow in x- or y-direction.

<sup>(b)</sup>only present for cases of floating objects with linear flow in positive z-direction (i.e. upwards flow, downward object motion).

When considering fully submerged objects in a rotational flow, the top, bottom and outside walls of the cylindrical domain all have `noSlip` boundary conditions for velocity. This is opposite to the `slip` boundary conditions of the passive walls in the linear flow case but serves the same purpose to not influence the flow. The difference in the required boundary condition results from the way the flow is created. While the linear flow originates from a wall with appropriate boundary conditions, the rotational flow is created using the moving reference frame (MRF) paradigm. This approach relies on creating source terms in the domain, such that the complete cylindrical domain except for the object to be analyze appears to be rotating and thus the object experiences a rotational flow. Thus, the passive walls are, unlike in the linear case, not stationary and need another boundary condition to stay passive. The benefit of using the MRF approach is that the use of moving meshes can be avoided and thus it is computationally less expensive, while being able to create simulated situations that are virtually identical to a moving mesh approach under pure rotational motion. Consequently, the watertight boundary condition for the object is achieved by a `movingWallVelocity` condition with 0 value. Finally, the internal field is initially set to `uniform` 0 velocity since a rotational flow is constantly accelerated and thus the equilibrium state needs to be created during a simulation run. As for the linear case, `zeroGradient` boundary conditions for all walls and a `uniform` value of 0 for the internal field are appropriate for pressure. With these initial and boundary conditions (Tab. 2) a real-life turntable experiment is recreated in simulation. The flow experienced by the object is basically the same as if a cylindrical container filled with fluid was rotated on a turntable while the object was submerged in the flow but hindered to rotate with it (e.g. being fixed on a stick that is mounted on a fixed point outside the turntable).

Table 2: Boundary and initial conditions for cases of objects in a rotational flow.
| domain part | velocity (U) | pressure (p) | turbulent viscosity (nut) |
|:---:|:---:|:---:|:---:|
| top<sup>(a)</sup> | `noSlip` | `zeroGradient` | `nutUSpaldingWallFunction` |
| bottom | `noSlip` | `zeroGradient` | `nutUSpaldingWallFunction` |
| outside wall | `noSlip` | `zeroGradient` | `nutUSpaldingWallFunction` |
| STL surface | `movingWallVelocity uniform (0 0 0)` | `zeroGradient` | `nutUSpaldingWallFunction` |
| internal field | `uniform (0 0 0)` | `uniform 0` | `uniform 0.0001` |
| free surface<sup>(b)</sup> | `symmetry` | `symmetry` | `symmetry` |

<sup>(a)</sup>becomes free surface for cases of floating objects with rotational flow around the ùëß-axis.

<sup>(b)</sup>only present for cases of floating objects.

To transition the boundary conditions from the situation of a fully submerged object to an object floating on the free surface, the boundary condition of the wall representing the free surface needs to be adjusted. Since multiphase approaches and moving meshes are avoided for HyDaMaCa for the sake of computational efficiency, the free surface is always flat and undisturbed by the flow.

For linear flows in x- and y-direction a previously passive wall of the fluid domain becomes the free surface. Setting the boundary condition for velocity and pressure to `symmetry` for this wall is the only change required to transition these cases from a fully submerged to a floating object. Free surface flows are characterized by both zero perpendicular normal stress and zero parallel shear stress. This leads to the so called kinematic and dynamic conditions for the free surface. The `symmetry` boundary condition in OpenFOAM can be used to represent these conditions (Tab. 1), specifically when mass and heat transfer processes are not considered, as is done here. The CFD experiment obtained with these changes again represents a flume tank experiment, just with a free surface present. For linear flows in the z-direction however, the free surface is simultaneously the in- or outlet of the domain. The `symmetry` boundary condition is incompatible with the required condition for an in- or outlet. Thus, the boundary conditions were chosen such that the free surface is actually an in- or outlet. In the former case the boundary conditions were thus unchanged compared to a fully submerged object. In the latter case reverse flow needs to be prevented. As such, the `inletOutlet` boundary condition was chosen for velocity alongside a constant pressure value (Tab. 1). Since the object to be analyzed is piercing the in- or outlet of the domain under these conditions, a CFD experiment that is physically impossible in the real world is obtained in this case. The object is simultaneously performing a continuous up- or downwards heaving motion, while the free surface is not changing its position relative to the object.

Focusing on rotational flows with objects at the free surface and rotation about the x- and y-axis a new wall (i.e. the rectangular face of the half cylinder, Fig. 1f) is created representing the free surface. Since this new boundary is neither an inlet nor an outlet of the domain (because all rotational domains using MRF to create the flow have neither) the `symmetry` boundary condition can be applied for both velocity and pressure (Tab. 2). It should be noted that a physically impossible experiment is created in these cases again, despite the correct choice of boundary conditions for the free surface. Similarly to the linear flow along the x-direction, in this case the floating object is undergoing a constant rolling or pitching motion, while the free surface does not change its position with respect to the object. In fact, the flow is actually created at one half of the free surface and consumed by the other half while having constant angular velocity everywhere within the fluid volume. Lastly, rotational flows with the object at the free surface and rotation around the z-axis are simply created by assigning the symmetry boundary conditions for both velocity and pressure to the top wall of the cylindrical domain which is the free surface in that case (Tab. 2). This situation does represent a physically possible turntable experiment equivalent to the previously described ones, just with the object to be analyzed not within the volume of fluid but at its surface.

The large eddy simulation (LES) paradigm is chosen to simulate turbulence in all cases. In particular, the Smagorinsky model was used, which requires the definition of initial and boundary conditions for the turbulent viscosity for the model to work. For the linear cases (Tab. 1) in- and outlet boundary conditions were set to `calculated`, such that the turbulent viscosity was fitted to the in- and outflow velocities. For the passive walls as well as the feature surface in both linear and rotational cases (Tab. 1 and 2) the `nutUSpaldingWallFunction` was chosen to support both low and high Reynolds numbers without having to change the boundary condition for the turbulence model. To initialize the turbulence, model the internal field was set to a `uniform` value of 0.0001. The `symmetry` boundary condition was chosen for the free surface for the turbulence model was well. For the specfic case of the free surface being in- or outlet for the heave motion cases `calculated` was chosen for the inlet and `inletOutlet` for the outlet case.
